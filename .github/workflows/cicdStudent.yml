name: CI/CD Nest # 워크플로우 이름(깃허브 Actions에 표시)

on:
  push:
    branches: [main] # main 브랜치에 push 되면 실행

jobs:
  ci:
    runs-on: ubuntu-latest # CI를 돌릴 실행 환경(OS)
    steps:
      - uses: actions/checkout@v3 # 레포지토리 소스코드 체크아웃
      - uses: actions/setup-node@v3 # Node.js 환경 세팅
      - run: npm install # 의존성 설치
      - run: npm run lint # ESLint로 코드 규칙 검사
      - run: npm run test # Jest로 테스트 실행
      - run: npm run build # Nest 빌드(컴파일)

  cd:
    needs: ci # CI 성공 후에만 배포(CD) 실행
    runs-on: ubuntu-latest # CD를 돌릴 실행 환경(OS)
    steps:
      - uses: actions/checkout@v3 # 배포에 필요한 소스코드 체크아웃
      - run: npm install -g @railway/cli # Railway CLI 전역 설치
      - run: railway up --service=cicd_nest # Railway에 서비스 배포/업데이트
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }} # Railway 인증 토큰(Secrets에서 주입)
      - run: echo "Done railway deploys" # 배포 완료 로그 출력
